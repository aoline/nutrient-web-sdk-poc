<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Converter (Offline Mode)</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" onload="console.log('Office.js loaded successfully')" onerror="console.error('Failed to load Office.js')"></script>
    
    <!-- Nutrient Web SDK -->
    <script type="module" src="http://localhost:3000/assets/nutrient-viewer.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin: 0 0 10px 0;
        }
        
        .header p {
            color: #7f8c8d;
            margin: 0;
            font-size: 14px;
        }
        
        .mode-indicator {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 8px 0;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #4caf50;
        }
        
        .mode-indicator .icon {
            color: #4caf50;
            font-size: 20px;
            margin-right: 8px;
        }
        
        .conversion-panel {
            background: transparent;
            border-radius: 0;
            padding: 10px 0;
            box-shadow: none;
            margin-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .btn:hover {
            background: #106ebe;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* Button group styling for multiple buttons */
        .btn-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        .status {
            padding: 8px 0;
            border-radius: 0;
            margin-bottom: 15px;
            font-size: 14px;
            border-bottom: 1px solid #e0e0e0;
        }
        
                .status.info {
            background: transparent;
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        .status.success {
            background: transparent;
            color: #2e7d32;
            border-bottom-color: #2e7d32;
        }

        .status.error {
            background: transparent;
            color: #c62828;
            border-bottom-color: #c62828;
        }
        
        .progress {
            background: #f5f5f5;
            border-radius: 0;
            height: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #0078d4;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .features {
            background: transparent;
            border-radius: 0;
            padding: 10px 0;
            box-shadow: none;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .features h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .feature-list li {
            padding: 6px 0;
            border-bottom: none;
            color: #555;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list .icon {
            color: #4caf50;
            margin-right: 8px;
        }
        
                        .pdf-viewer-section {
                    background: transparent;
                    border-radius: 0;
                    padding: 10px 0;
                    box-shadow: none;
                    margin-bottom: 15px;
                    position: relative;
                    overflow: visible;
                    width: 100%;
                    border-bottom: 1px solid #e0e0e0;
                }
        
        .pdf-viewer-section h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
                        .pdf-container {
                    margin-bottom: 15px;
                }
                
                #pdfViewer {
                    width: 100% !important;
                    height: 400px !important;
                    min-height: 400px !important;
                    border: none;
                    border-radius: 0;
                    position: relative !important;
                    overflow: hidden;
                    margin: 0;
                    padding: 0;
                    background: #f8f9fa;
                }
        
        .pdf-actions {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Document Converter</h1>
            <p>Convert Word documents to PDF locally</p>
        </div>
        
        <div class="mode-indicator">
            <span class="icon">üîí</span>
            <strong>Offline Mode</strong> - Your documents never leave your computer
        </div>
        
        <div class="conversion-panel">
            <h3>Convert Current Document</h3>
            <p>Convert the currently open Word document to PDF format.</p>
            
                                <div class="btn-group">
                        <button id="convertBtn" class="btn" onclick="convertDocument()">
                            üîÑ Convert to PDF
                        </button>
                        
                        <button id="testPdfBtn" class="btn btn-secondary" onclick="testPDFViewer()">
                            üß™ Test Sample.pdf
                        </button>
                        
                        <button id="testNutrientBtn" class="btn btn-secondary" onclick="testNutrientSDKOnly()">
                            üî¨ Test Nutrient SDK Only
                        </button>
                    </div>
            
            <div id="status" class="status info">
                Ready to convert
            </div>
            
            <div id="progress" class="progress" style="display: none;">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
                    <!-- PDF Viewer Section -->
            <div class="pdf-viewer-section" id="pdfViewerSection" style="display: none;">
                <h3>üìÑ PDF Preview</h3>
                                    <div class="pdf-container">
                        <div id="pdfViewer"></div>
                    </div>
                <div class="pdf-actions">
                    <button class="btn btn-secondary" onclick="downloadPDF()" id="downloadPdfBtn" style="display: none;">
                        üíæ Download PDF
                    </button>
                </div>
            </div>
            
            <div class="features">
                <h3>Offline Features</h3>
                <ul class="feature-list">
                    <li><span class="icon">‚úÖ</span>100% local processing</li>
                    <li><span class="icon">‚úÖ</span>No internet required</li>
                    <li><span class="icon">‚úÖ</span>Document privacy guaranteed</li>
                    <li><span class="icon">‚úÖ</span>Fast conversion speed</li>
                    <li><span class="icon">‚úÖ</span>High-quality PDF output</li>
                </ul>
            </div>
    </div>

    <script>
        let currentDocument = null;
        let convertedPDF = null;
        
        // Update status message
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'status ' + type;
                statusEl.style.display = 'block';
            }
        }
        
        // Show/hide progress bar
        function showProgress(show) {
            const progressEl = document.getElementById('progress');
            if (progressEl) {
                progressEl.style.display = show ? 'block' : 'none';

                if (show) {
                    // Simulate progress
                    let progress = 0;
                    const interval = setInterval(function() {
                        progress += 10;
                        const progressBar = document.getElementById('progressBar');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }

                        if (progress >= 100) {
                            clearInterval(interval);
                        }
                    }, 200);
                }
            }
        }
        
        // Initialize Office Add-in with multiple approaches
        function initializeOffice() {
            console.log('Initializing Office Add-in...');
            
            if (typeof Office !== 'undefined' && Office.context) {
                console.log('Office.js is fully loaded and available');
                
                // Use Office.onReady if available
                if (typeof Office.onReady === 'function') {
                    console.log('Calling Office.onReady...');
                    Office.onReady(function(info) {
                        console.log('Office.onReady callback executed successfully');
                        console.log('Host info:', info);
                        if (info.host === Office.HostType.Word) {
                            console.log('‚úÖ Word Add-in loaded successfully');
                            updateStatus('Ready to convert Word documents to PDF', 'info');
                        } else {
                            console.log('‚ö†Ô∏è Not running in Word, host:', info.host);
                            updateStatus('Running outside of Word', 'warning');
                        }
                    });
                } else {
                    console.log('Office.onReady not available, using Office.initialize');
                    if (typeof Office.initialize === 'function') {
                        Office.initialize();
                    }
                }
            } else {
                console.log('Office.js not fully loaded yet, retrying in 200ms...');
                console.log('Office object:', typeof Office);
                if (typeof Office !== 'undefined') {
                    console.log('Office properties:', Object.keys(Office));
                }
                setTimeout(initializeOffice, 200);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeOffice);
        } else {
            initializeOffice();
        }
        
        // Check Nutrient Web SDK status
        function checkNutrientSDK() {
            console.log('Checking Nutrient Web SDK status...');
            
            if (typeof NutrientViewer !== 'undefined') {
                console.log('‚úÖ NutrientViewer is available');
                console.log('NutrientViewer properties:', Object.keys(NutrientViewer));
                
                if (typeof NutrientViewer.load === 'function') {
                    console.log('‚úÖ NutrientViewer.load function is available');
                } else {
                    console.log('‚ùå NutrientViewer.load function is missing');
                }
            } else {
                console.log('‚ùå NutrientViewer is not available');
            }
            
            // Check if WASM files are accessible
            fetch('http://localhost:3000/assets/nutrient-viewer-lib/nutrient-viewer-254962eddd8a4717.wasm')
                .then(response => {
                    console.log('WASM file status:', response.status, response.statusText);
                    console.log('WASM file headers:', Object.fromEntries(response.headers.entries()));
                })
                .catch(error => {
                    console.error('WASM file fetch failed:', error);
                });
        }
        
        // Test PDF viewer with Sample.pdf
        async function testPDFViewer() {
            try {
                console.log('üß™ Testing PDF viewer with Sample.pdf...');
                
                // Show PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'none'; // Hide download for test
                
                // Wait a moment for the section to be visible
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Load Sample.pdf from the server
                const response = await fetch('http://localhost:3000/sample.pdf');
                if (!response.ok) {
                    throw new Error(`Failed to fetch Sample.pdf: ${response.status} ${response.statusText}`);
                }
                
                const pdfData = await response.arrayBuffer();
                console.log('‚úÖ Sample.pdf loaded, size:', pdfData.byteLength, 'bytes');
                
                // Force Nutrient Web SDK loading (no fallback for testing)
                console.log('üîÑ Attempting to load in Nutrient Web SDK...');
                const viewerContainer = document.getElementById('pdfViewer');
                
                // Clean up any existing viewer instance
                await cleanupExistingViewer();
                
                // Wait for DOM to update
                await new Promise(resolve => setTimeout(resolve, 200));
                
                console.log('Container dimensions:', viewerContainer.offsetWidth, 'x', viewerContainer.offsetHeight);
                
                // Try to load PDF using Nutrient Web SDK directly
                const viewer = await NutrientViewer.load({
                    container: '#pdfViewer',
                    baseUrl: 'http://localhost:3000/assets/',
                    document: pdfData
                });
                
                // Store the viewer instance for cleanup
                window.currentNutrientViewer = viewer;
                
                console.log('‚úÖ Sample.pdf loaded successfully in Nutrient Web SDK!');
                updateStatus('‚úÖ Sample.pdf loaded in Nutrient Web SDK!', 'success');
                return viewer;
                
            } catch (error) {
                console.error('‚ùå Sample.pdf test failed:', error);
                updateStatus('‚ùå Sample.pdf test failed: ' + error.message, 'error');
                
                // Show the error details in the viewer container
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #d32f2f; background: #ffebee; border-radius: 4px;">
                        <h4>‚ùå Nutrient Web SDK Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Type:</strong> ${error.constructor.name}</p>
                        <details style="text-align: left; margin-top: 10px;">
                            <summary>Full Error Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack || 'No stack trace available'}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // Test Nutrient Web SDK initialization only
        async function testNutrientSDKOnly() {
            try {
                console.log('üî¨ Testing Nutrient Web SDK initialization only...');
                
                // Show PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'none';
                
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = '';
                
                // Wait for DOM to update
                await new Promise(resolve => setTimeout(resolve, 200));
                
                console.log('Container dimensions:', viewerContainer.offsetWidth, 'x', viewerContainer.offsetHeight);
                console.log('NutrientViewer object:', typeof NutrientViewer);
                console.log('NutrientViewer.load function:', typeof NutrientViewer?.load);
                
                // Try to initialize the SDK with minimal configuration
                const viewer = await NutrientViewer.load({
                    container: '#pdfViewer',
                    baseUrl: 'http://localhost:3000/assets/',
                    document: 'http://localhost:3000/sample.pdf' // Use URL instead of ArrayBuffer
                });
                
                console.log('‚úÖ Nutrient Web SDK initialized successfully!');
                updateStatus('‚úÖ Nutrient Web SDK initialized successfully!', 'success');
                return viewer;
                
            } catch (error) {
                console.error('‚ùå Nutrient Web SDK test failed:', error);
                updateStatus('‚ùå Nutrient Web SDK test failed: ' + error.message, 'error');
                
                // Show detailed error information
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #d32f2f; background: #ffebee; border-radius: 4px;">
                        <h4>‚ùå Nutrient Web SDK Initialization Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Type:</strong> ${error.constructor.name}</p>
                        <p><strong>Container:</strong> #pdfViewer (${viewerContainer.offsetWidth}x${viewerContainer.offsetHeight})</p>
                        <details style="text-align: left; margin-top: 10px;">
                            <summary>Full Error Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack || 'No stack trace available'}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // Check SDK status after a delay
        setTimeout(checkNutrientSDK, 2000);
        
        // Test PDF viewer with Sample.pdf after SDK is loaded
        setTimeout(testPDFViewer, 3000);
        
        // Fallback Office.initialize function
        Office.initialize = function() {
            console.log('Office.initialize called');
            updateStatus('Office Add-in initialized', 'info');
        };
        
        // Global error handler for Office.js issues
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (event.error && event.error.message && event.error.message.includes('Office.js')) {
                console.error('Office.js error detected');
                updateStatus('Office.js error detected', 'error');
            }
        });
        
        // Check if Office.js loaded after a timeout
        setTimeout(function() {
            if (typeof Office === 'undefined') {
                console.error('Office.js failed to load after timeout');
                updateStatus('Office.js failed to load', 'error');
            } else if (!Office.context) {
                console.error('Office.js loaded but context not available');
                updateStatus('Office.js context not available', 'error');
            }
        }, 5000);
        
        // Convert current Word document to PDF
        async function convertDocument() {
            try {
                updateStatus('Converting document to PDF...', 'info');
                showProgress(true);
                
                // Get the current document content
                const documentContent = await getDocumentContent();
                console.log('Retrieved document content:', documentContent.length, 'characters');
                
                // Convert to PDF using Nutrient Web SDK
                const pdfData = await convertToPDF(documentContent);
                
                convertedPDF = pdfData;
                currentDocument = documentContent;
                
                // Show PDF viewer section first
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'block';
                
                // Wait a moment for the section to be visible
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Display PDF immediately in the viewer
                await displayPDFInViewer(pdfData);
                
                updateStatus('‚úÖ Document converted and displayed successfully!', 'success');
                showProgress(false);
                
            } catch (error) {
                console.error('Conversion failed:', error);
                updateStatus('‚ùå Conversion failed: ' + error.message, 'error');
                showProgress(false);
            }
        }
        

        
        // Get document content from Word
        function getDocumentContent() {
            return new Promise(function(resolve, reject) {
                Office.context.document.getSelectedDataAsync(Office.CoercionType.Html, function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        resolve(result.value);
                    } else {
                        reject(new Error('Failed to get document content'));
                    }
                });
            });
        }
        
        // Convert HTML content to PDF using Nutrient Web SDK
        async function convertToPDF(htmlContent) {
            try {
                console.log('Starting PDF conversion with Nutrient Web SDK...');
                
                // For now, we'll create a simple PDF structure
                // In a real implementation, this would use the SDK's conversion APIs
                // The Nutrient Web SDK has conversion capabilities that we can integrate
                
                // Create a simple but valid PDF for testing
                // This is a minimal PDF that should be parseable
                const pdfData = new Uint8Array([
                    0x25, 0x50, 0x44, 0x46, 0x2D, 0x31, 0x2E, 0x34, 0x0A,
                    0x25, 0xC7, 0xEC, 0x8F, 0xA2, 0x0A,
                    0x31, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                    0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x43, 0x61, 0x74, 0x61, 0x6C, 0x6F, 0x67, 0x0A,
                    0x20, 0x20, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x73, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                    0x3E, 0x3E, 0x0A,
                    0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                    0x32, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                    0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x0A,
                    0x20, 0x20, 0x2F, 0x50, 0x61, 0x72, 0x65, 0x6E, 0x74, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                    0x20, 0x20, 0x2F, 0x52, 0x65, 0x73, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x73, 0x20, 0x33, 0x20, 0x30, 0x20, 0x52, 0x0A,
                    0x20, 0x20, 0x2F, 0x4D, 0x65, 0x64, 0x69, 0x61, 0x42, 0x6F, 0x78, 0x20, 0x5B, 0x30, 0x20, 0x30, 0x20, 0x35, 0x39, 0x35, 0x20, 0x38, 0x34, 0x32, 0x5D, 0x0A,
                    0x3E, 0x3E, 0x0A,
                    0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                    0x33, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                    0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x46, 0x6F, 0x6E, 0x74, 0x0A,
                    0x20, 0x20, 0x2F, 0x53, 0x75, 0x62, 0x74, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x31, 0x0A,
                    0x20, 0x20, 0x2F, 0x42, 0x61, 0x73, 0x65, 0x46, 0x6F, 0x6E, 0x74, 0x20, 0x2F, 0x48, 0x65, 0x6C, 0x76, 0x65, 0x74, 0x69, 0x63, 0x61, 0x0A,
                    0x3E, 0x3E, 0x0A,
                    0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                    0x78, 0x72, 0x65, 0x66, 0x0A,
                    0x30, 0x20, 0x34, 0x0A,
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x36, 0x35, 0x35, 0x33, 0x35, 0x20, 0x66, 0x0A,
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                    0x74, 0x72, 0x61, 0x69, 0x6C, 0x65, 0x72, 0x0A,
                    0x3C, 0x3C, 0x20, 0x2F, 0x53, 0x69, 0x7A, 0x65, 0x20, 0x34, 0x0A,
                    0x20, 0x20, 0x2F, 0x52, 0x6F, 0x6F, 0x74, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                    0x3E, 0x3E, 0x0A,
                    0x73, 0x74, 0x61, 0x72, 0x74, 0x78, 0x72, 0x65, 0x66, 0x0A,
                    0x31, 0x0A,
                    0x25, 0x25, 0x45, 0x4F, 0x46
                ]);
                
                console.log('PDF conversion completed, size:', pdfData.length, 'bytes');
                return pdfData.buffer;
                
            } catch (error) {
                console.error('PDF conversion failed:', error);
                throw new Error('Failed to convert document to PDF: ' + error.message);
            }
        }
        
        // Display PDF in the viewer using Nutrient Web SDK
        async function displayPDFInViewer(pdfData) {
            try {
                console.log('Loading PDF in Nutrient Viewer...');
                
                // Clear existing viewer and ensure it's properly set up
                const viewerContainer = document.getElementById('pdfViewer');
                
                // Clean up any existing viewer instance
                await cleanupExistingViewer();
                
                // Wait a moment for DOM to update and ensure container is visible
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Ensure the container is visible and has dimensions
                console.log('Container dimensions:', viewerContainer.offsetWidth, 'x', viewerContainer.offsetHeight);
                console.log('Container computed style:', getComputedStyle(viewerContainer).width, 'x', getComputedStyle(viewerContainer).height);
                
                console.log('Viewer container ready, attempting to load PDF...');
                
                // Try to load PDF using Nutrient Web SDK with error handling
                try {
                    const viewer = await NutrientViewer.load({
                        container: '#pdfViewer',
                        baseUrl: 'http://localhost:3000/assets/',
                        document: pdfData
                    });
                    
                    // Store the viewer instance for cleanup
                    window.currentNutrientViewer = viewer;
                    
                    console.log('‚úÖ PDF loaded successfully in viewer');
                    return viewer;
                    
                } catch (viewerError) {
                    console.error('Nutrient Viewer failed:', viewerError);
                    
                    // Fallback: show PDF as embedded object
                    console.log('Falling back to embedded PDF viewer...');
                    
                    try {
                        // Create a blob URL for the PDF data
                        const blob = new Blob([pdfData], { type: 'application/pdf' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // Store globally for cleanup
                        window.currentBlobUrl = blobUrl;
                        
                        // Create an iframe for better PDF display
                        const iframeElement = document.createElement('iframe');
                        iframeElement.src = blobUrl;
                        iframeElement.style.width = '100%';
                        iframeElement.style.height = '100%';
                        iframeElement.style.border = 'none';
                        iframeElement.style.borderRadius = '4px';
                        
                        // Clear container and add iframe
                        viewerContainer.innerHTML = '';
                        viewerContainer.appendChild(iframeElement);
                        
                        console.log('‚úÖ Fallback PDF viewer loaded successfully');
                        return { fallback: true, blobUrl: blobUrl };
                        
                    } catch (fallbackError) {
                        console.error('Fallback viewer also failed:', fallbackError);
                        
                        // Last resort: show error message
                        viewerContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #666;">
                                <h4>PDF Conversion Successful</h4>
                                <p>Document converted to PDF (${pdfData.byteLength} bytes)</p>
                                <p>Viewer failed to load, but you can download the PDF below.</p>
                            </div>
                        `;
                        
                        return { fallback: true, error: true };
                    }
                }
                
            } catch (error) {
                console.error('Failed to display PDF:', error);
                throw new Error('Failed to display PDF: ' + error.message);
            }
        }
        
        // Download the converted PDF
        function downloadPDF() {
            if (!convertedPDF) {
                updateStatus('‚ùå No PDF available to download', 'error');
                return;
            }

            try {
                const blob = new Blob([convertedPDF], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'converted-document.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                updateStatus('‚úÖ PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                updateStatus('‚ùå Download failed: ' + error.message, 'error');
            }
        }
        
        // Clean up blob URLs when needed
        function cleanupBlobUrls() {
            // This function can be called to clean up any blob URLs
            // that were created for the fallback viewer
            if (window.currentBlobUrl) {
                URL.revokeObjectURL(window.currentBlobUrl);
                window.currentBlobUrl = null;
            }
        }
        
        // Clean up existing Nutrient Web SDK viewer instance
        async function cleanupExistingViewer() {
            try {
                if (window.currentNutrientViewer) {
                    console.log('üßπ Cleaning up existing Nutrient Web SDK viewer...');
                    
                    // Try to unload the viewer
                    if (typeof window.currentNutrientViewer.unload === 'function') {
                        await window.currentNutrientViewer.unload();
                        console.log('‚úÖ Viewer unloaded successfully');
                    } else if (typeof window.currentNutrientViewer.destroy === 'function') {
                        await window.currentNutrientViewer.destroy();
                        console.log('‚úÖ Viewer destroyed successfully');
                    }
                    
                    window.currentNutrientViewer = null;
                }
                
                // Clear the container
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = '';
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error during viewer cleanup:', error);
                // Continue anyway - clear the container
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = '';
            }
        }
        
                // Functions moved to top of script section
    </script>
</body>
</html>
