<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Converter (Offline Mode)</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" onload="console.log('Office.js loaded successfully')" onerror="console.error('Failed to load Office.js')"></script>
    
    <!-- Nutrient Web SDK -->
    <script src="http://localhost:3000/assets/nutrient-viewer.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f7f5; /* Light beige background from Nutrient site */
            color: #000000; /* Black text like their site */
            width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: #f8f7f5;
            width: 100%;
        }
        
        /* Header Section with Logo and Description */
        .header-section {
            background: #ffffff;
            padding: 24px 20px;
            text-align: center;
            border-bottom: none;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            margin: 20px;
        }
        
        /* Main Content Section with Buttons and Status */
        .main-content-section {
            background: #ffffff; /* Pure white like their main content box */
            padding: 24px 20px;
            text-align: center;
            border-bottom: none;
            margin-bottom: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow like their white box */
            border-radius: 12px;
            margin: 20px;
        }
        
        .nutrient-logo-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.6;
        }
        
        .nutrient-logo {
            height: 70px;
            margin: 0 auto 12px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        

        

        
        .nutrient-tagline {
            font-size: 14px;
            margin: 0;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .header {
            background: #ffffff; /* Pure white like their main content box */
            padding: 24px 20px 20px 20px;
            margin: 0 20px 20px 20px;
            border-bottom: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            color: #000000; /* Black text like their main heading */
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header p {
            color: #000000; /* Black text like their body text */
            margin: 8px 0 0 0;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
        }
        
        .mode-indicator {
            background: #ffffff; /* Pure white like their main content box */
            border: 1px solid #e0e0e0; /* Light gray border like their buttons */
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 20px 24px 20px;
            color: #000000; /* Black text */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .mode-indicator .icon {
            color: #e6b3e6; /* Light purple/pink like their accents */
            margin-right: 8px;
            font-size: 18px;
        }
        
        .mode-indicator strong {
            color: #000000; /* Black text */
            font-weight: 600;
        }
        
        .conversion-panel {
            background: #ffffff; /* Pure white like their main content box */
            border-radius: 12px;
            padding: 24px 20px;
            margin: 0 20px 24px 20px;
            border: 1px solid #e0e0e0; /* Light gray border */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .conversion-panel h3 {
            color: #000000; /* Black text like their headings */
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        
        .conversion-panel p {
            color: #000000; /* Black text like their body text */
            margin: 0 0 20px 0;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #333333; /* Dark gray/black like their "LAUNCH DEMO" button */
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            letter-spacing: -0.2px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            background: #222222;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #d9d9d9; /* Light beige/gray like their "TRY FOR FREE" and "GET STARTED" buttons */
            color: #000000; /* Black text */
            box-shadow: 0 4px 16px rgba(217, 217, 217, 0.3);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 24px rgba(217, 217, 217, 0.4);
            background: #e0e0e0;
        }
        
        .status {
            background: #ffffff; /* Pure white background */
            border: 1px solid #e0e0e0; /* Light gray border */
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            color: #000000; /* Black text */
            font-size: 15px;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .status.info {
            border-left: 4px solid #e6b3e6; /* Light purple/pink like their accents */
            background: #faf8ff; /* Very light purple tint */
        }
        
        .status.success {
            border-left: 4px solid #66b366; /* Green like their "CONTACT SALES" button */
            background: #f8fff8; /* Very light green tint */
        }
        
        .status.error {
            border-left: 4px solid #ff4d4d; /* Red like their profile icon */
            background: #fff8f8; /* Very light red tint */
        }
        
        .status.warning {
            border-left: 4px solid #e6b3e6; /* Light purple/pink like their accents */
            background: #faf8ff; /* Very light purple tint */
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e6b3e6, #d4a5d4, #c297c2, #e6b3e6);
            background-size: 200% 100%;
            border-radius: 4px;
            animation: progressShimmer 2s ease-in-out infinite;
            position: relative;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressGlow 1.5s ease-in-out infinite;
        }
        
        @keyframes progressShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        @keyframes progressGlow {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .status.info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        .status.warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #f57c00;
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        .status.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            animation: statusShake 0.5s ease-in-out infinite;
        }
        
        .status.success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            animation: statusSuccess 0.6s ease-out;
        }
        
        @keyframes statusPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
                transform: scale(1.02);
            }
        }
        
        @keyframes statusShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        @keyframes statusSuccess {
            0% { 
                transform: scale(0.8);
                opacity: 0;
            }
            50% { 
                transform: scale(1.1);
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Loading spinner for long operations */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e6b3e6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Animated dots for processing */
        .processing-dots {
            display: inline-block;
            margin-left: 5px;
        }
        
        .processing-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .pdf-viewer-section {
            background: #ffffff; /* Pure white like their main content box */
            border-radius: 0;
            padding: 0;
            margin: 0;
            border: none;
            width: 100%;
        }
        
        .pdf-viewer-section h3 {
            color: #000000; /* Black text like their headings */
            margin: 0 0 0 0;
            font-size: 18px;
            font-weight: 600;
            padding: 20px 20px 16px 20px;
            background: #f8f7f5; /* Light beige like their page background */
            border-bottom: 1px solid #e0e0e0; /* Light gray border */
            letter-spacing: -0.3px;
        }
        
        .pdf-container {
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        #pdfViewer {
            width: 100% !important;
            height: 500px !important;
            min-height: 500px !important;
            border: none;
            border-radius: 0;
            position: relative !important;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background: #f8f7f5; /* Light beige like their page background */
            display: block;
            box-sizing: border-box;
        }
        
        .pdf-actions {
            text-align: center;
            padding: 0px;
            background: #f8f7f5; /* Light beige like their page background */
            border-top: 1px solid #e0e0e0; /* Light gray border */
        }
        
        .features {
            background: #ffffff; /* Pure white like their main content box */
            border-radius: 12px;
            padding: 24px 20px;
            margin: 0 20px 24px 20px;
            border: 1px solid #e0e0e0; /* Light gray border */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .features h3 {
            color: #000000; /* Black text like their headings */
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .feature-list li {
            color: #000000; /* Black text like their body text */
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0; /* Light gray border */
            font-size: 15px;
            display: flex;
            align-items: center;
            line-height: 1.5;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list .icon {
            margin-right: 12px;
            font-size: 18px;
            color: #66b366; /* Green like their "CONTACT SALES" button */
        }
        
        /* Scrollbar styling - matching Nutrient's clean aesthetic */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f8f7f5; /* Light beige like their page background */
        }
        
        ::-webkit-scrollbar-thumb {
            background: #e0e0e0; /* Light gray like their borders */
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #d9d9d9; /* Slightly darker gray */
        }
        
        /* Responsive design improvements */
        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .conversion-panel,
            .features {
                margin: 0 16px 20px 16px;
                padding: 20px 16px;
            }
            
            .mode-indicator {
                margin: 0 16px 20px 16px;
                padding: 16px;
            }
            
            .header-section {
                margin: 16px;
            }
            
            .header {
                margin: 0 16px 20px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header-section">
        <a href="https://nutrient.io" target="_blank" rel="noopener" class="nutrient-logo">
        <svg width="100%" height="36" viewBox="0 0 208 36" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.1524 22.1521C1.8582 22.1521 0 20.2939 0 17.9997C0 15.7055 1.8582 13.8473 4.1524 13.8473C6.44659 13.8473 8.30479 15.7055 8.30479 17.9997C8.30479 20.2939 6.44659 22.1521 4.1524 22.1521ZM45.6763 13.8473C43.3821 13.8473 41.524 15.7055 41.524 17.9997C41.524 20.2939 43.3821 22.1521 45.6763 22.1521C47.9705 22.1521 49.8287 20.2939 49.8287 17.9997C49.8287 15.7055 47.9705 13.8473 45.6763 13.8473ZM6.34071 28.1647C4.58424 29.6388 4.35379 32.259 5.82789 34.0154C7.30199 35.7719 9.92215 36.0024 11.6786 34.5283C13.4351 33.0542 13.6655 30.434 12.1914 28.6775C10.7173 26.9211 8.09717 26.6906 6.34071 28.1647ZM43.488 7.8346C45.2445 6.3605 45.475 3.74033 44.0009 1.98387C42.5268 0.227407 39.9066 -0.0030509 38.1501 1.47105C36.3937 2.94515 36.1632 5.56531 37.6373 7.32177C39.1114 9.07824 41.7316 9.3087 43.488 7.8346ZM11.6786 1.47313C9.92215 -0.000974749 7.30199 0.227407 5.82789 1.98595C4.35379 3.74449 4.58217 6.36257 6.34071 7.83667C8.09925 9.31077 10.7173 9.08239 12.1914 7.32385C13.6655 5.56531 13.4372 2.94723 11.6786 1.47313ZM43.488 28.1647C41.7316 26.6906 39.1114 26.919 37.6373 28.6775C36.1632 30.434 36.3916 33.0542 38.1501 34.5283C39.9066 36.0024 42.5268 35.774 44.0009 34.0154C45.475 32.259 45.2466 29.6388 43.488 28.1647ZM32.8849 19.2661C31.1284 17.792 28.5083 18.0204 27.0342 19.779C25.5601 21.5375 25.7884 24.1556 27.547 25.6297C29.3055 27.1038 31.9236 26.8754 33.3977 25.1169C34.8718 23.3583 34.6434 20.7402 32.8849 19.2661ZM22.2818 10.3696C20.5253 8.89553 17.9051 9.12391 16.431 10.8825C14.9569 12.641 15.1853 15.2591 16.9438 16.7332C18.7024 18.2073 21.3205 17.9789 22.7946 16.2204C24.2687 14.4618 24.0403 11.8437 22.2818 10.3696Z" fill="#1A1414"></path>
            <path d="M83.2482 4.00294H86.8124V32.0934H82.7174L73.1011 15.2088C72.579 14.2696 71.494 12.1667 69.849 8.90002H69.8111C69.8636 10.1017 69.9103 11.4113 69.9482 12.8288C69.9861 14.2463 70.0065 15.3079 70.0065 16.0109V32.0934H66.4424V4.00294H70.4382L80.0749 20.6921C80.559 21.5292 81.434 23.1654 82.6999 25.6096L83.4057 26.96H83.4436C83.3911 25.8896 83.3445 24.6559 83.3065 23.2588C83.2686 21.8617 83.2482 20.7388 83.2482 19.89V4.00294ZM104.254 23.2996C104.254 27.4792 102.53 29.5675 99.0828 29.5675C98.3128 29.5675 97.639 29.4975 97.0645 29.3604C96.4899 29.2234 95.9474 28.9054 95.4399 28.4096C95.0607 28.045 94.7865 27.6279 94.6174 27.1671C94.4482 26.7034 94.3461 26.2396 94.314 25.7759C94.282 25.3121 94.2645 24.6617 94.2645 23.8275V12.0354H90.5428V24.0229C90.5428 24.9621 90.572 25.7788 90.6303 26.4729C90.6886 27.1671 90.8374 27.8525 91.0707 28.5409C91.304 29.2292 91.6657 29.8242 92.147 30.3346C92.8645 31.1046 93.7074 31.6734 94.6728 32.0379C95.6382 32.4025 96.7757 32.5863 98.0824 32.5863C99.5203 32.5863 100.772 32.2859 101.842 31.685C102.912 31.0842 103.714 30.2238 104.251 29.0979V32.0963H107.856V12.0354H104.251V23.2996H104.254ZM118.677 6.45294H115.113V12.0354H110.901V15.0513H115.113V27.1584C115.113 28.9725 115.603 30.2821 116.583 31.0871C117.563 31.8921 119.141 32.2917 121.322 32.2917C121.871 32.2917 122.416 32.2625 122.959 32.2042C123.501 32.1459 123.947 32.07 124.3 31.9796L124.222 28.6896C123.215 28.9259 122.346 29.0425 121.617 29.0425C120.888 29.0425 120.275 28.9871 119.864 28.8763C119.453 28.7654 119.152 28.5671 118.963 28.2784C118.773 27.9896 118.68 27.5784 118.68 27.0446V15.0571H124.379V12.0413H118.68V6.45294H118.677ZM134.73 12.9746C133.456 13.7329 132.63 14.6721 132.251 15.795V12.0354H128.646V32.0934H132.251V22.9059C132.251 20.8029 132.563 19.1638 133.19 17.9884C133.817 16.8129 134.666 16.0079 135.737 15.5704C136.807 15.1329 138.108 14.9142 139.633 14.9142C140.246 14.9142 140.666 14.9346 140.887 14.9725L140.966 11.5454C140.103 11.5454 139.554 11.5571 139.321 11.5834C137.53 11.7525 136.002 12.2163 134.727 12.9746H134.73ZM170.287 18.5979C170.588 19.785 170.737 21.0217 170.737 22.2992C170.737 22.6784 170.731 22.9584 170.716 23.1421H155.497C155.535 25.35 156.025 26.9921 156.967 28.0684C157.906 29.1446 159.318 29.6842 161.199 29.6842C162.897 29.6842 164.215 29.3167 165.157 28.5788C166.099 27.8409 166.691 26.715 166.939 25.1984L170.424 25.4725C169.981 27.8088 168.978 29.5792 167.417 30.7809C165.857 31.9825 163.798 32.5834 161.237 32.5834C158.154 32.5834 155.754 31.6034 154.027 29.6463C152.394 27.8175 151.577 25.2771 151.577 22.025C151.577 20.5229 151.79 19.1346 152.213 17.8629C152.636 16.5884 153.269 15.4888 154.103 14.5613C154.978 13.5696 156.016 12.8171 157.218 12.3096C158.419 11.7992 159.744 11.5454 161.193 11.5454C162.812 11.5454 164.32 11.8896 165.717 12.575C167.114 13.2604 168.217 14.2434 169.027 15.5238C169.564 16.3871 169.981 17.4109 170.282 18.5979H170.287ZM167.015 20.2225C167.003 19.6479 166.898 19.0238 166.703 18.3529C166.507 17.6821 166.254 17.1163 165.939 16.6584C165.428 15.9 164.792 15.3488 164.028 15.0017C163.264 14.6546 162.334 14.4825 161.237 14.4825C160.14 14.4825 159.181 14.675 158.358 15.06C157.536 15.445 156.92 15.9788 156.518 16.6554C156.177 17.2038 155.934 17.7929 155.783 18.4171C155.634 19.0442 155.549 19.645 155.538 20.2196H167.018L167.015 20.2225ZM190.672 15.6113C190.444 14.9113 190.094 14.3075 189.625 13.8C188.893 13.03 188.044 12.4613 187.079 12.0967C186.113 11.7321 184.97 11.5484 183.652 11.5484C180.583 11.5484 178.518 12.7354 177.462 15.1125V12.0384H173.857V32.0963H177.462V21.0275C177.462 18.5075 178.005 16.7984 179.087 15.9059C180.172 15.0104 181.371 14.5642 182.692 14.5642C183.436 14.5642 184.089 14.6342 184.652 14.7713C185.212 14.9084 185.749 15.2263 186.259 15.7221C186.638 16.0867 186.915 16.5067 187.09 16.9763C187.265 17.4459 187.37 17.9184 187.402 18.3967C187.434 18.8721 187.452 19.5371 187.452 20.3859V32.0992H191.194V20.1904C191.194 19.2367 191.165 18.4113 191.107 17.7113C191.048 17.0113 190.902 16.3142 190.675 15.6142L190.672 15.6113ZM207.338 15.0513V12.0354H201.639V6.45294H198.074V12.0354H193.863V15.0513H198.074V27.1584C198.074 28.9725 198.564 30.2821 199.544 31.0871C200.524 31.8921 202.102 32.2917 204.284 32.2917C204.832 32.2917 205.378 32.2625 205.92 32.2042C206.463 32.1459 206.909 32.07 207.262 31.9796L207.183 28.6896C206.177 28.9259 205.308 29.0425 204.579 29.0425C203.849 29.0425 203.237 28.9871 202.826 28.8763C202.414 28.7654 202.114 28.5671 201.924 28.2784C201.735 27.9896 201.642 27.5784 201.642 27.0446V15.0571H207.341L207.338 15.0513ZM144.557 32.1225H148.162V12.0646H144.557V32.1225ZM146.359 3.41669C144.904 3.41669 143.725 4.59502 143.725 6.05044C143.725 7.50585 144.904 8.68419 146.359 8.68419C147.814 8.68419 148.993 7.50585 148.993 6.05044C148.993 4.59502 147.814 3.41669 146.359 3.41669Z" fill="#1A1414"></path>
            </svg>
        </a>
     <p class="nutrient-tagline"></p>
     <p><b>Document processing and conversion by Nutrient.</b></p>
     <p>Convert Word documents to PDF locally. Your documents never leave your computer with 100% local processing. Fast conversion speed, High-quality PDF output.</p>
    </div>
         
    <div class="main-content-section">
                                                     <div class="btn-group">
                <button id="convertBtn" class="btn" onclick="convertDocument()">
                    🔄 Convert Current Document to PDF
                </button>
                
                <button id="getDocxBtn" class="btn btn-secondary" onclick="getActualWordDocument()">
                    📄 Get Actual DOCX
                </button>
                        
                        <button id="testPdfBtn" class="btn btn-secondary" onclick="testPDFViewer()">
                            🧪 Test Sample.pdf
                        </button>
                        
                        <button id="testNutrientBtn" class="btn btn-secondary" onclick="testNutrientSDKOnly()">
                            🔬 Test Nutrient SDK Only
                        </button>
                        
                        <button id="testDocxBtn" class="btn btn-secondary" onclick="testDocumentContent()">
                            📄 Test DOCX Content
                        </button>
                        
                        <button id="testFullProcessBtn" class="btn btn-secondary" onclick="testFullProcess()">
                            🔄 Test Full 3-Step Process
                        </button>
                        
                        <button id="testDebugBtn" class="btn btn-secondary" onclick="testButtonClick()">
                            🧪 Test JavaScript
                        </button>
                    </div>
            
            <div id="status" class="status info">
                Ready to convert
            </div>
            
            <div id="progress" class="progress" style="display: none;">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
                    <!-- PDF Viewer Section -->
            <div class="pdf-viewer-section" id="pdfViewerSection" style="display: none;">
                <div class="pdf-container">
                    <div id="pdfViewer"></div>
                </div>
                <div class="pdf-actions">
                    <button class="btn btn-secondary" onclick="downloadPDF()" id="downloadPdfBtn" style="display: none;">
                        💾 Download PDF
                    </button>
                </div>            
            </div>

    <script>
        let currentDocument = null;
        let convertedPDF = null;
        
        // Debug function to test if JavaScript is working
        function testButtonClick() {
            console.log('🎯 Button clicked! JavaScript is working.');
            alert('Button clicked! JavaScript is working.');
        }
        
        // Debug: Log when script loads
        console.log('🚀 Script section loaded');
        console.log('🔍 Available functions:', {
            convertDocument: typeof convertDocument,
            getActualWordDocument: typeof getActualWordDocument,
            testPDFViewer: typeof testPDFViewer,
            testNutrientSDKOnly: typeof testNutrientSDKOnly,
            testDocumentContent: typeof testDocumentContent,
            testFullProcess: typeof testFullProcess,
            testButtonClick: typeof testButtonClick
        });
        
        // Update status with animated elements
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                // Add loading spinner for info and warning states
                let displayMessage = message;
                if (type === 'info' || type === 'warning') {
                    displayMessage = `<span class="loading-spinner"></span>${message}<span class="processing-dots"></span>`;
                } else if (type === 'success') {
                    displayMessage = `✅ ${message}`;
                } else if (type === 'error') {
                    displayMessage = `❌ ${message}`;
                }
                
                statusEl.innerHTML = displayMessage;
                statusEl.className = 'status ' + type;
                statusEl.style.display = 'block';
            }
        }
        
        // Show progress with animation
        function showProgress(show) {
            const progressEl = document.getElementById('progress');
            const progressBarEl = document.getElementById('progressBar');
            
            if (show) {
                progressEl.style.display = 'block';
                // Animate progress bar
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90; // Don't complete until done
                    progressBarEl.style.width = progress + '%';
                }, 500);
                
                // Store interval for cleanup
                window.progressInterval = interval;
            } else {
                progressEl.style.display = 'none';
                // Complete the progress bar
                if (progressBarEl) {
                    progressBarEl.style.width = '100%';
                    setTimeout(() => {
                        progressBarEl.style.width = '0%';
                    }, 300);
                }
                // Clear interval
                if (window.progressInterval) {
                    clearInterval(window.progressInterval);
                    window.progressInterval = null;
                }
            }
        }
        
        // Initialize Office Add-in with multiple approaches
        function initializeOffice() {
            console.log('Initializing Office Add-in...');
            
            if (typeof Office !== 'undefined' && Office.context) {
                console.log('Office.js is fully loaded and available');
                
                // Use Office.onReady if available
                if (typeof Office.onReady === 'function') {
                    console.log('Calling Office.onReady...');
                    Office.onReady(function(info) {
                        console.log('Office.onReady callback executed successfully');
                        console.log('Host info:', info);
                        if (info.host === Office.HostType.Word) {
                            console.log('✅ Word Add-in loaded successfully');
                            updateStatus('Ready to convert Word documents to PDF', 'info');
                        } else {
                            console.log('⚠️ Not running in Word, host:', info.host);
                            updateStatus('Running outside of Word', 'warning');
                        }
                    });
                } else {
                    console.log('Office.onReady not available, using Office.initialize');
                    if (typeof Office.initialize === 'function') {
                        Office.initialize();
                    }
                }
            } else {
                console.log('Office.js not fully loaded yet, retrying in 200ms...');
                console.log('Office object:', typeof Office);
                if (typeof Office !== 'undefined') {
                    console.log('Office properties:', Object.keys(Office));
                }
                setTimeout(initializeOffice, 200);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeOffice);
        } else {
            initializeOffice();
        }
        
        // Check Nutrient Web SDK status
        function checkNutrientSDK() {
            console.log('Checking Nutrient Web SDK status...');
            
            if (typeof NutrientViewer !== 'undefined') {
                console.log('✅ NutrientViewer is available');
                console.log('NutrientViewer properties:', Object.keys(NutrientViewer));
                
                if (typeof NutrientViewer.load === 'function') {
                    console.log('✅ NutrientViewer.load function is available');
                } else {
                    console.log('❌ NutrientViewer.load function is missing');
                }
            } else {
                console.log('❌ NutrientViewer is not available');
            }
            
            // Check if WASM files are accessible
            fetch('http://localhost:3000/assets/nutrient-viewer-lib/nutrient-viewer-254962eddd8a4717.wasm')
                .then(response => {
                    console.log('WASM file status:', response.status, response.statusText);
                    console.log('WASM file headers:', Object.fromEntries(response.headers.entries()));
                })
                .catch(error => {
                    console.error('WASM file fetch failed:', error);
                });
        }
        
        // Test PDF viewer with sample.pdf
        async function testPDFViewer() {
            try {
                console.log('🧪 Testing PDF viewer with sample.pdf...');
                
                // Show PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'none'; // Hide download for test
                
                // Wait a moment for the section to be visible
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Try the direct URL approach first (simplest and most reliable)
                console.log('🔄 Attempting to load sample.pdf directly with URL...');
                
                // Clean approach: Use viewer.unload() then viewer.load() if we have an existing viewer
                if (window.currentNutrientViewer) {
                    console.log('🔄 Using existing viewer - unloading and loading new document...');
                    try {
                        await window.currentNutrientViewer.unload();
                        console.log('✅ Existing viewer unloaded');
                        
                        // Now load the PDF into the same viewer
                        await window.currentNutrientViewer.load({
                            document: 'http://localhost:3000/sample.pdf'
                        });
                        console.log('✅ sample.pdf loaded successfully using viewer.load()!');
                        updateStatus('sample.pdf loaded using existing viewer!', 'success');
                        return window.currentNutrientViewer;
                        
                    } catch (viewerError) {
                        console.warn('⚠️ Viewer.load() failed, creating new viewer:', viewerError.message);
                        window.currentNutrientViewer = null;
                    }
                }
                
                // If no existing viewer or viewer.load() failed, create new one
                console.log('🔄 Creating new viewer for sample.pdf...');
                const viewer = await NutrientViewer.load({
                    container: '#pdfViewer',
                    baseUrl: 'http://localhost:3000/assets/',
                    document: 'http://localhost:3000/sample.pdf'
                });
                
                // Store the viewer instance
                window.currentNutrientViewer = viewer;
                
                console.log('✅ sample.pdf loaded successfully with new viewer!');
                updateStatus('sample.pdf loaded using new viewer!', 'success');
                return viewer;
                
            } catch (error) {
                console.error('❌ sample.pdf test failed:', error);
                updateStatus('sample.pdf test failed: ' + error.message, 'error');
                
                // Show the error details in the viewer container
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #d32f2f; background: #ffebee; border-radius: 4px;">
                        <h4>❌ Nutrient Web SDK Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Type:</strong> ${error.constructor.name}</p>
                        <details style="text-align: left; margin-top: 10px;">
                            <summary>Full Error Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack || 'No stack trace available'}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // Test document content retrieval from Word
        async function testDocumentContent() {
            try {
                console.log('📄 Testing document content retrieval...');
                updateStatus('Testing document content retrieval...', 'info');
                
                const documentContent = await getDocumentContent();
                
                console.log('✅ Document content test successful!');
                console.log('Content length:', documentContent.length, 'characters');
                console.log('Content preview:', documentContent.substring(0, 500) + '...');
                
                updateStatus(`Document content retrieved: ${documentContent.length} characters`, 'success');
                
                // Show the content in a simple display
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div style="text-align: left;">
                            <strong>✅ Document Content Retrieved Successfully!</strong><br>
                            <strong>Length:</strong> ${documentContent.length} characters<br>
                            <strong>Preview:</strong><br>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;">
                                ${documentContent.substring(0, 1000).replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                        </div>
                    `;
                }
                
                return documentContent;
                
            } catch (error) {
                console.error('❌ Document content test failed:', error);
                updateStatus('Document content test failed: ' + error.message, 'error');
                
                // Show detailed error information
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div style="text-align: left; color: #d32f2f;">
                            <strong>❌ Document Content Test Failed</strong><br>
                            <strong>Error:</strong> ${error.message}<br>
                            <strong>Type:</strong> ${error.constructor.name}<br>
                            <details style="margin-top: 10px;">
                                <summary>Full Error Details</summary>
                                <pre style="background: #ffebee; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px;">${error.stack || 'No stack trace available'}</pre>
                            </details>
                        </div>
                    `;
                }
            }
        }
        
        // Test the complete 3-step process
        async function testFullProcess() {
            try {
                console.log('🔄 Testing complete 3-step process...');
                updateStatus('Testing complete 3-step process...', 'info');
                
                // Step 1: Get DOCX content
                console.log('📋 Step 1: Getting DOCX content...');
                updateStatus('Step 1: Getting DOCX content...', 'info');
                const documentContent = await getDocumentContent();
                console.log('✅ Step 1 completed: DOCX content retrieved');
                
                // Step 2: Convert to PDF
                console.log('🔄 Step 2: Converting to PDF...');
                updateStatus('Step 2: Converting to PDF...', 'info');
                const pdfData = await convertToPDF(documentContent);
                console.log('✅ Step 2 completed: PDF conversion successful');
                
                // Step 3: Load into viewer
                console.log('👁️ Step 3: Loading PDF into viewer...');
                updateStatus('Step 3: Loading PDF into viewer...', 'info');
                
                // Show PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'block';
                
                // Wait for section to be visible
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const viewer = await displayPDFInViewer(pdfData);
                console.log('✅ Step 3 completed: PDF loaded into viewer');
                
                // Success!
                console.log('🎉 All 3 steps completed successfully!');
                updateStatus('All 3 steps completed successfully!', 'success');
                
                return { documentContent, pdfData, viewer };
                
            } catch (error) {
                console.error('❌ Full process test failed:', error);
                updateStatus('Full process test failed: ' + error.message, 'error');
                
                // Show detailed error information
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div style="text-align: left; color: #d32f2f;">
                            <strong>❌ Full Process Test Failed</strong><br>
                            <strong>Error:</strong> ${error.message}<br>
                            <strong>Type:</strong> ${error.constructor.name}<br>
                            <details style="margin-top: 10px;">
                                <summary>Full Error Details</summary>
                                <pre style="background: #ffebee; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px;">${error.stack || 'No stack trace available'}</pre>
                            </details>
                        </div>
                    `;
                }
            }
        }
        
        // Test Nutrient Web SDK initialization only
        async function testNutrientSDKOnly() {
            try {
                console.log('🔬 Testing Nutrient Web SDK initialization only...');
                
                // Show PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'none';
                
                const viewerContainer = document.getElementById('pdfViewer');
                console.log('Container dimensions:', viewerContainer.offsetWidth, 'x', viewerContainer.offsetHeight);
                console.log('NutrientViewer object:', typeof NutrientViewer);
                console.log('NutrientViewer.load function:', typeof NutrientViewer?.load);
                
                // Try to initialize the SDK with minimal configuration using the helper
                const viewer = await switchViewerDocument(
                    new Uint8Array(await fetch('http://localhost:3000/sample.pdf').then(r => r.arrayBuffer())),
                    'application/pdf',
                    'sample.pdf'
                );
                
                console.log('✅ Nutrient Web SDK initialized successfully!');
                updateStatus('Nutrient Web SDK initialized successfully!', 'success');
                return viewer;
                
            } catch (error) {
                console.error('❌ Nutrient Web SDK test failed:', error);
                updateStatus('Nutrient Web SDK test failed: ' + error.message, 'error');
                
                // Show detailed error information
                const viewerContainer = document.getElementById('pdfViewer');
                viewerContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #d32f2f; background: #ffebee; border-radius: 4px;">
                        <h4>❌ Nutrient Web SDK Initialization Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Type:</strong> ${error.constructor.name}</p>
                        <p><strong>Container:</strong> #pdfViewer (${viewerContainer.offsetWidth}x${viewerContainer.offsetHeight})</p>
                        <details style="text-align: left; margin-top: 10px;">
                            <summary>Full Error Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack || 'No stack trace available'}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // Check SDK status after a delay
        setTimeout(checkNutrientSDK, 2000);
        
        // Test PDF viewer with Sample.pdf after SDK is loaded
        setTimeout(testPDFViewer, 3000);
        
        // Fallback Office.initialize function
        Office.initialize = function() {
            console.log('Office.initialize called');
            updateStatus('Office Add-in initialized', 'info');
        };
        
        // Global error handler for Office.js issues
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (event.error && event.error.message && event.error.message.includes('Office.js')) {
                console.error('Office.js error detected');
                updateStatus('Office.js error detected', 'error');
            }
        });
        
        // Check if Office.js loaded after a timeout
        setTimeout(function() {
            if (typeof Office === 'undefined') {
                console.error('Office.js failed to load after timeout');
                updateStatus('Office.js failed to load', 'error');
            } else if (!Office.context) {
                console.error('Office.js loaded but context not available');
                updateStatus('Office.js context not available', 'error');
            }
        }, 5000);
        
        // Convert current Word document to PDF
        async function convertDocument() {
            try {
                updateStatus('Converting document to PDF...', 'info');
                showProgress(true);
                
                // Check Office.js readiness first
                if (typeof Office === 'undefined') {
                    throw new Error('Office.js is not loaded. Please run this in Word.');
                }
                
                if (!Office.context || !Office.context.document) {
                    throw new Error('Office.js context not available. Please ensure you are in a Word document.');
                }
                
                console.log('🔄 Office.js status check passed, starting conversion workflow...');
                updateStatus('🔄 Getting your current Word document and converting to PDF...', 'info');
                
                // This function does the complete workflow: get DOCX, load in viewer, convert to PDF
                const docxData = await getActualWordDocument();
                
                if (docxData && docxData.byteLength > 0) {
                    console.log('✅ Complete workflow completed successfully!');
                    console.log('✅ Final DOCX data size:', docxData.byteLength, 'bytes');
                    updateStatus('✅ Document converted to PDF successfully! Check the viewer and download button.', 'success');
                    showProgress(false);
                } else {
                    throw new Error('Failed to get current Word document - no data received');
                }
                
            } catch (error) {
                console.error('❌ Conversion failed:', error);
                console.error('❌ Error stack:', error.stack);
                updateStatus('❌ Conversion failed: ' + error.message, 'error');
                showProgress(false);
                
                // Show detailed error in status
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div style="text-align: left; color: #d32f2f;">
                            <strong>❌ Conversion Failed</strong><br>
                            <strong>Error:</strong> ${error.message}<br>
                            <strong>Type:</strong> ${error.constructor.name}<br>
                            <details style="margin-top: 10px;">
                                <summary>Full Error Details</summary>
                                <pre style="background: #ffebee; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px;">${error.stack || 'No stack trace available'}</pre>
                            </details>
                        </div>
                    `;
                }
            }
        }
        
        // Convert actual DOCX to PDF using the SDK
        async function convertActualDocxToPDF() {
            try {
                if (!window.actualDocxData || window.actualDocxData.byteLength === 0) {
                    throw new Error('No actual DOCX data available');
                }
                
                console.log('🔄 Converting actual DOCX to PDF...');
                updateStatus('Converting your actual Word document to PDF...', 'info');
                
                // Show the PDF viewer section
                document.getElementById('pdfViewerSection').style.display = 'block';
                document.getElementById('downloadPdfBtn').style.display = 'none';
                
                // Wait for the section to be visible
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Load the actual DOCX into the viewer using the helper function
                const viewer = await switchViewerDocument(window.actualDocxData, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'current-word-document.docx');
                
                console.log('✅ Actual DOCX loaded in viewer, now exporting to PDF...');
                
                // Export to PDF
                const pdfArrayBuffer = await viewer.exportPDF();
                console.log('✅ PDF export completed, size:', pdfArrayBuffer.byteLength, 'bytes');
                
                // Store the converted PDF
                window.convertedPDF = pdfArrayBuffer;
                
                // Show download button
                document.getElementById('downloadPdfBtn').style.display = 'block';
                
                updateStatus('Your Word document converted to PDF successfully!', 'success');
                showProgress(false);
                
                return pdfArrayBuffer;
                
            } catch (error) {
                console.error('❌ Failed to convert actual DOCX to PDF:', error);
                updateStatus('DOCX to PDF conversion failed: ' + error.message, 'error');
                showProgress(false);
                throw error;
            }
        }
        
        // Get the actual Word document as DOCX file - Production Grade Implementation
        async function getActualWordDocument() {
            try {
                updateStatus('Getting actual Word document as DOCX...', 'info');
                
                if (typeof Office === 'undefined' || !Office.context || !Office.context.document) {
                    throw new Error('Office.js not ready or no document context');
                }
                
                console.log('🔍 Attempting to get actual Word document...');
                console.log('🔍 Office.js version:', Office.version);
                console.log('🔍 Document context available:', !!Office.context.document);
                
                // Use the production-grade implementation
                let docxBytes;
                try {
                    console.log('🔄 Trying production-grade method (getFileAsync)...');
                    docxBytes = await getCurrentDocxReliable();
                    console.log('✅ Got actual DOCX data via production-grade method, size:', docxBytes.length, 'bytes');
                } catch (productionError) {
                    console.warn('⚠️ Production-grade method failed, trying fallback:', productionError.message);
                    console.warn('⚠️ Production error details:', productionError);
                    updateStatus('Advanced method failed, trying fallback approach...', 'warning');
                    
                    // Try fallback approach
                    try {
                        console.log('🔄 Trying fallback method (getSelectedDataAsync)...');
                        const fallbackData = await getDocumentContentFallback();
                        console.log('✅ Got document data via fallback, size:', fallbackData.byteLength, 'bytes');
                        
                        // Use fallback data
                        docxBytes = new Uint8Array(fallbackData);
                        updateStatus('Using fallback method - some formatting may be lost', 'warning');
                    } catch (fallbackError) {
                        console.error('❌ All methods failed:', fallbackError);
                        console.error('❌ Production error:', productionError);
                        console.error('❌ Fallback error:', fallbackError);
                        throw new Error(`All DOCX retrieval methods failed. Production: ${productionError.message}, Fallback: ${fallbackError.message}`);
                    }
                }
                
                console.log('✅ Got DOCX data, size:', docxBytes.length, 'bytes');
                
                // Convert Uint8Array to ArrayBuffer for compatibility
                const docxData = docxBytes.buffer.slice(docxBytes.byteOffset, docxBytes.byteOffset + docxBytes.byteLength);
                
                // Download the DOCX file
                const blob = new Blob([docxData], { 
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
                });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'actual-word-document.docx';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateStatus('Actual Word document downloaded as DOCX!', 'success');
                
                // Store for potential use with SDK
                window.actualDocxData = docxData;
                
                // Now load the actual DOCX into the viewer
                console.log('🔄 Loading actual DOCX into Nutrient Web SDK viewer...');
                updateStatus('Loading your actual Word document into the viewer...', 'info');
                
                try {
                    // Show the PDF viewer section
                    document.getElementById('pdfViewerSection').style.display = 'block';
                    document.getElementById('downloadPdfBtn').style.display = 'none';
                    
                    // Wait for the section to be visible
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Debug: Check container state
                    const viewerContainer = document.getElementById('pdfViewer');
                    console.log('🔍 Viewer container state:', {
                        id: viewerContainer.id,
                        dimensions: `${viewerContainer.offsetWidth}x${viewerContainer.offsetHeight}`,
                        visible: viewerContainer.style.display !== 'none',
                        parentVisible: viewerContainer.parentElement.style.display !== 'none'
                    });
                    
                    // Load the actual DOCX into the viewer using the helper function
                    const viewer = await switchViewerDocument(docxData, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'current-word-document.docx');
                    
                    console.log('✅ Actual Word document loaded successfully in viewer!');
                    updateStatus('Your actual Word document is now displayed in the viewer!', 'success');
                    
                    // Automatically convert to PDF after loading
                    console.log('🔄 Automatically converting to PDF...');
                    updateStatus('Automatically converting your document to PDF...', 'info');
                    
                    try {
                        const pdfArrayBuffer = await viewer.exportPDF();
                        console.log('✅ PDF conversion completed, size:', pdfArrayBuffer.byteLength, 'bytes');
                        
                        // Store the converted PDF
                        window.convertedPDF = pdfArrayBuffer;
                        
                        // Show download button
                        document.getElementById('downloadPdfBtn').style.display = 'block';
                        
                        updateStatus('Document converted to PDF successfully! Click "💾 Download PDF" to save.', 'success');
                        
                    } catch (pdfError) {
                        console.error('❌ PDF conversion failed:', pdfError);
                        updateStatus('Document loaded in viewer but PDF conversion failed: ' + pdfError.message, 'warning');
                    }
                    
                    // Add a button to convert this DOCX to PDF
                    const convertButton = document.createElement('button');
                    convertButton.className = 'btn';
                    convertButton.style.marginTop = '10px';
                    convertButton.onclick = () => convertActualDocxToPDF();
                    convertButton.textContent = '🔄 Convert This DOCX to PDF';
                    
                    document.querySelector('.pdf-actions').appendChild(convertButton);
                    
                } catch (viewerError) {
                    console.error('❌ Failed to load DOCX in viewer:', viewerError);
                    updateStatus('Failed to load document in viewer: ' + viewerError.message, 'error');
                    
                    // Show detailed error information
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0; color: #c62828;';
                    errorDiv.innerHTML = `
                        <h4>❌ Viewer Loading Failed</h4>
                        <p><strong>Error:</strong> ${viewerError.message}</p>
                        <p><strong>Type:</strong> ${viewerError.constructor.name}</p>
                        <details style="margin-top: 10px;">
                            <summary>Full Error Details</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${viewerError.stack || 'No stack trace available'}</pre>
                        </details>
                    `;
                    
                    document.getElementById('status').appendChild(errorDiv);
                }
                
                return docxData;
                
            } catch (error) {
                console.error('❌ Failed to get actual Word document:', error);
                updateStatus('Failed to get actual Word document: ' + error.message, 'error');
                
                // Show detailed error information
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 15px; margin: 15px 0; color: #c62828;';
                errorDiv.innerHTML = `
                    <h4>❌ DOCX Retrieval Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Type:</strong> ${error.constructor.name}</p>
                    <details style="margin-top: 10px;">
                        <summary>Full Error Details</summary>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack || 'No stack trace available'}</pre>
                    </details>
                `;
                
                document.getElementById('status').appendChild(errorDiv);
                throw error;
            }
        }
        
        // Production-grade DOCX retrieval with Office.js getFileAsync
        async function getCurrentDocxReliable(options = {}) {
            const {
                maxRetries = 3,
                sliceSize = 4 * 1024 * 1024, // 4 MB
                timeoutMs = 15_000,          // 15 seconds
            } = options;

            console.log('🚀 Starting production-grade DOCX retrieval...');

            // Try Office getFileAsync with retries and timeout
            try {
                return await getDocxViaGetFileAsync({ maxRetries, sliceSize, timeoutMs });
            } catch (error) {
                console.warn('[getFileAsync] failed:', error?.message || error);
                throw new Error(`Failed to get current Word document: ${error.message}`);
            }
        }

        // Path A: Office.getFileAsync with proper Word API saving
        async function getDocxViaGetFileAsync({ maxRetries, sliceSize, timeoutMs }) {
            // Save first using Word API (reduces "internal error/5001" and timeouts)
            await trySaveWithWordAPI();

            // Serialize calls: don't run two exports at once
            await gateGetFileAsync();

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    return await withTimeout(_getDocxOnce(sliceSize), timeoutMs, 'getFileAsync timeout');
                } catch (e) {
                    attempt++;
                    if (attempt >= maxRetries) throw e;
                    console.log(`🔄 Retry attempt ${attempt} after failure:`, e.message);
                    await delay(1000 * attempt); // exponential backoff
                }
            }
        }

        function _getDocxOnce(sliceSize) {
            return new Promise((resolve, reject) => {
                Office.context.document.getFileAsync(
                    Office.FileType.Compressed,
                    { sliceSize },
                    (res) => {
                        if (res.status !== Office.AsyncResultStatus.Succeeded) {
                            return reject(new Error(`${res.status} - ${res.error?.message || 'getFileAsync failed'}`));
                        }
                        const file = res.value; // Office.File
                        const { sliceCount } = file;
                        console.log(`📊 File has ${sliceCount} slices`);
                        const slices = new Array(sliceCount);
                        let i = 0;

                        const failAndClose = (err) => file.closeAsync(() => reject(err instanceof Error ? err : new Error(String(err))));

                        const next = () => {
                            console.log(`🔄 Getting slice ${i + 1} of ${sliceCount}`);
                            file.getSliceAsync(i, (r) => {
                                if (r.status !== Office.AsyncResultStatus.Succeeded) {
                                    return failAndClose(new Error(`${r.status} - ${r.error?.message || 'getSliceAsync failed'}`));
                                }
                                slices[i] = r.value.data; // base64 string
                                i++;
                                if (i < sliceCount) return next();

                                file.closeAsync(() => {
                                    try {
                                        const base64 = slices.join('');
                                        console.log('✅ All slices collected, converting to Uint8Array...');
                                        resolve(base64ToUint8(base64));
                                    } catch (e) {
                                        reject(e);
                                    }
                                });
                            });
                        };
                        next();
                    }
                );
            });
        }



        // Download PDF function
        function downloadPDF() {
            try {
                if (!window.convertedPDF) {
                    updateStatus('No PDF available for download', 'error');
                    return;
                }
                
                console.log('💾 Downloading PDF...');
                updateStatus('Downloading PDF...', 'info');
                
                const blob = new Blob([window.convertedPDF], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'converted-document.pdf';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateStatus('PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('❌ PDF download failed:', error);
                updateStatus('PDF download failed: ' + error.message, 'error');
            }
        }
        
        // Clean approach: Use viewer.unload() then viewer.load()
        async function switchViewerDocument(documentData, documentType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', documentName = 'document.docx') {
            try {
                console.log(`📄 Loading ${documentType} into viewer, size:`, documentData.byteLength, 'bytes');
                console.log('🔍 Document data type:', typeof documentData, 'constructor:', documentData.constructor.name);
                
                let viewer;
                
                // If we have an existing viewer, use the clean pattern
                if (window.currentNutrientViewer) {
                    console.log('🔄 Using existing viewer - unloading and loading new document...');
                    try {
                        await window.currentNutrientViewer.unload();
                        console.log('✅ Existing viewer unloaded');
                        
                        // Now load the new document into the same viewer
                        await window.currentNutrientViewer.load({
                            document: {
                                type: documentType,
                                data: documentData,
                                name: documentName
                            }
                        });
                        console.log('✅ Document loaded successfully using viewer.load()!');
                        return window.currentNutrientViewer;
                        
                    } catch (viewerError) {
                        console.warn('⚠️ Viewer.load() failed, creating new viewer:', viewerError.message);
                        window.currentNutrientViewer = null;
                    }
                }
                
                // If no existing viewer or viewer.load() failed, create new one
                console.log('🔄 Creating new viewer with document...');
                viewer = await NutrientViewer.load({
                    container: '#pdfViewer',
                    baseUrl: 'http://localhost:3000/assets/',
                    document: {
                        type: documentType,
                        data: documentData,
                        name: documentName
                    }
                });
                
                // Store the viewer instance
                window.currentNutrientViewer = viewer;
                console.log('✅ Document loaded successfully in new viewer!');
                
                return viewer;
                
            } catch (error) {
                console.error('❌ Failed to switch viewer document:', error);
                throw error;
            }
        }
        

        
        // Helper functions
        async function trySaveWithWordAPI() {
            console.log('💾 Attempting to save document first using Word API...');
            try {
                await Word.run(async (ctx) => {
                    ctx.document.save();
                    await ctx.sync();
                });
                console.log('✅ Document saved successfully using Word API');
            } catch (error) {
                console.warn('⚠️ Word API save failed, continuing anyway:', error.message);
                // Don't fail the entire operation if save fails
            }
        }

        let _gating = Promise.resolve();
        function gateGetFileAsync() {
            const prev = _gating;
            let release;
            _gating = new Promise(r => (release = r));
            return prev.finally(() => release());
        }

        function base64ToUint8(b64) {
            const bin = atob(b64);
            const out = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
            return out;
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

        async function withTimeout(promise, ms, label = 'timeout') {
            let t;
            const timer = new Promise((_, rej) => t = setTimeout(() => rej(new Error(`${label} after ${ms} ms`)), ms));
            try {
                return await Promise.race([promise, timer]);
            } finally {
                clearTimeout(t);
            }
        }


        
        // Get document content from Word
        function getDocumentContent() {
            return new Promise(function(resolve, reject) {
                console.log('🔍 Attempting to get document content from Word...');
                
                if (!Office || !Office.context || !Office.context.document) {
                    reject(new Error('Office.js context not available'));
                    return;
                }
                
                Office.context.document.getSelectedDataAsync(Office.CoercionType.Html, function(result) {
                    console.log('📄 getSelectedDataAsync result:', result);
                    
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        console.log('✅ Document content retrieved successfully');
                        console.log('Content length:', result.value.length, 'characters');
                        console.log('Content preview:', result.value.substring(0, 200) + '...');
                        resolve(result.value);
                    } else {
                        console.error('❌ Failed to get document content:', result.status, result.error);
                        reject(new Error(`Failed to get document content: ${result.status} - ${result.error?.message || 'Unknown error'}`));
                    }
                });
            });
        }
        
        // Convert HTML content to PDF using Nutrient Web SDK
        async function convertToPDF(htmlContent) {
            try {
                console.log('🔄 Starting real PDF conversion with Nutrient Web SDK...');
                console.log('Input HTML content length:', htmlContent.length, 'characters');
                console.log('HTML preview:', htmlContent.substring(0, 200) + '...');
                
                // First, let's try to use the Nutrient Web SDK's conversion capabilities
                // The SDK should have HTML to PDF conversion features
                
                try {
                    console.log('🔧 Attempting to use Nutrient Web SDK conversion...');
                    
                    // Create a temporary container for conversion
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.top = '-9999px';
                    tempContainer.style.width = '800px';
                    tempContainer.style.height = '600px';
                    tempContainer.innerHTML = htmlContent;
                    document.body.appendChild(tempContainer);
                    
                    // Try to use the SDK's conversion API if available
                    if (typeof NutrientViewer !== 'undefined' && NutrientViewer.convert) {
                        console.log('✅ Found NutrientViewer.convert, attempting conversion...');
                        
                        const pdfResult = await NutrientViewer.convert({
                            container: tempContainer,
                            format: 'pdf',
                            options: {
                                width: 800,
                                height: 600,
                                quality: 'high'
                            }
                        });
                        
                        document.body.removeChild(tempContainer);
                        console.log('✅ SDK conversion successful, PDF size:', pdfResult.byteLength, 'bytes');
                        return pdfResult;
                        
                    } else if (typeof NutrientViewer !== 'undefined' && NutrientViewer.export) {
                        console.log('✅ Found NutrientViewer.export, attempting export...');
                        
                        const pdfResult = await NutrientViewer.export({
                            container: tempContainer,
                            format: 'pdf'
                        });
                        
                        document.body.removeChild(tempContainer);
                        console.log('✅ SDK export successful, PDF size:', pdfResult.byteLength, 'bytes');
                        return pdfResult;
                        
                    } else {
                        console.log('⚠️ No conversion/export method found in SDK, using fallback...');
                        document.body.removeChild(tempContainer);
                    }
                    
                } catch (sdkError) {
                    console.warn('⚠️ SDK conversion failed, using fallback method:', sdkError);
                }
                
                // Fallback: Create a more realistic PDF that represents the content
                console.log('🔄 Using fallback PDF generation...');
                
                // Convert HTML content to a simple text representation
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                // Create a PDF that actually contains the document content
                const pdfBytes = createPDFWithContent(textContent, htmlContent);
                
                console.log('✅ Fallback PDF generation completed, size:', pdfBytes.length, 'bytes');
                return pdfBytes.buffer;
                
            } catch (error) {
                console.error('❌ PDF conversion failed:', error);
                throw new Error('Failed to convert document to PDF: ' + error.message);
            }
        }
        
        // Helper function to create a PDF with actual content
        function createPDFWithContent(textContent, htmlContent) {
            // This creates a more realistic PDF that contains the actual document content
            // We'll use a simple approach that embeds the text content
            
            const content = textContent.substring(0, 1000); // Limit content length
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            
            // Create a PDF with the actual content
            const pdfData = new Uint8Array([
                // PDF Header
                0x25, 0x50, 0x44, 0x46, 0x2D, 0x31, 0x2E, 0x34, 0x0A,
                0x25, 0xC7, 0xEC, 0x8F, 0xA2, 0x0A,
                
                // Catalog object
                0x31, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x43, 0x61, 0x74, 0x61, 0x6C, 0x6F, 0x67, 0x0A,
                0x20, 0x20, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x73, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Pages object
                0x32, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x73, 0x0A,
                0x20, 0x20, 0x2F, 0x4B, 0x69, 0x64, 0x73, 0x20, 0x5B, 0x33, 0x20, 0x30, 0x20, 0x52, 0x5D, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Page object
                0x33, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x50, 0x61, 0x67, 0x65, 0x0A,
                0x20, 0x20, 0x2F, 0x50, 0x61, 0x72, 0x65, 0x6E, 0x74, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x20, 0x20, 0x2F, 0x52, 0x65, 0x73, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x73, 0x20, 0x34, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x20, 0x20, 0x2F, 0x4D, 0x65, 0x64, 0x69, 0x61, 0x42, 0x6F, 0x78, 0x20, 0x5B, 0x30, 0x20, 0x30, 0x20, 0x35, 0x39, 0x35, 0x20, 0x38, 0x34, 0x32, 0x5D, 0x0A,
                0x20, 0x20, 0x2F, 0x43, 0x6F, 0x6E, 0x74, 0x65, 0x6E, 0x74, 0x73, 0x20, 0x35, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Font object
                0x34, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x46, 0x6F, 0x6E, 0x74, 0x0A,
                0x20, 0x20, 0x2F, 0x53, 0x75, 0x62, 0x74, 0x79, 0x70, 0x65, 0x20, 0x2F, 0x54, 0x79, 0x70, 0x65, 0x31, 0x0A,
                0x20, 0x20, 0x2F, 0x42, 0x61, 0x73, 0x65, 0x46, 0x6F, 0x6E, 0x74, 0x20, 0x2F, 0x48, 0x65, 0x6C, 0x76, 0x65, 0x74, 0x69, 0x63, 0x61, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Content stream object
                0x35, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x4C, 0x65, 0x6E, 0x67, 0x74, 0x68, 0x20, 0x36, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x73, 0x74, 0x72, 0x65, 0x61, 0x6D, 0x0A,
                
                // PDF content stream - this will contain the actual text
                0x42, 0x54, 0x0A,  // Begin text
                0x2F, 0x48, 0x65, 0x6C, 0x76, 0x65, 0x74, 0x69, 0x63, 0x61, 0x20, 0x31, 0x32, 0x20, 0x54, 0x66, 0x0A,  // Set font
                0x30, 0x20, 0x37, 0x30, 0x30, 0x20, 0x54, 0x64, 0x0A,  // Move to position
                
                // Add the actual document content as text
                ...encodeTextForPDF("Converted Word Document"),
                0x20, 0x54, 0x6A, 0x0A,  // Show text
                
                0x30, 0x20, 0x36, 0x38, 0x30, 0x20, 0x54, 0x64, 0x0A,  // Move down
                ...encodeTextForPDF("Content Preview:"),
                0x20, 0x54, 0x6A, 0x0A,
                
                // Add first few lines of content
                ...encodeTextForPDF(lines[0] || "No content available"),
                0x20, 0x54, 0x6A, 0x0A,
                
                0x45, 0x54, 0x0A,  // End text
                0x65, 0x6E, 0x64, 0x73, 0x74, 0x72, 0x65, 0x61, 0x6D, 0x0A,
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Length object
                0x36, 0x20, 0x30, 0x20, 0x6F, 0x62, 0x6A, 0x0A,
                0x31, 0x32, 0x35, 0x0A,  // Approximate length
                0x65, 0x6E, 0x64, 0x6F, 0x62, 0x6A, 0x0A,
                
                // Cross-reference table
                0x78, 0x72, 0x65, 0x66, 0x0A,
                0x30, 0x20, 0x37, 0x0A,  // 7 objects
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x36, 0x35, 0x35, 0x33, 0x35, 0x20, 0x66, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6E, 0x0A,
                
                // Trailer
                0x74, 0x72, 0x61, 0x69, 0x6C, 0x65, 0x72, 0x0A,
                0x3C, 0x3C, 0x20, 0x2F, 0x53, 0x69, 0x7A, 0x65, 0x20, 0x37, 0x0A,
                0x20, 0x20, 0x2F, 0x52, 0x6F, 0x6F, 0x74, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x0A,
                0x3E, 0x3E, 0x0A,
                0x73, 0x74, 0x61, 0x72, 0x74, 0x78, 0x72, 0x65, 0x66, 0x0A,
                0x31, 0x0A,
                0x25, 0x25, 0x45, 0x4F, 0x46
            ]);
            
            return pdfBytes;
        }
        
        // Helper function to encode text for PDF content stream
        function encodeTextForPDF(text) {
            if (!text) return [];
            const bytes = [];
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                if (charCode < 128) {
                    bytes.push(charCode);
                } else {
                    // For non-ASCII characters, use a safe fallback
                    bytes.push(0x3F); // Question mark
                }
            }
            return bytes;
        }
        
        // Display PDF in the viewer using Nutrient Web SDK
        async function displayPDFInViewer(pdfData) {
            try {
                console.log('Loading PDF in Nutrient Viewer...');
                
                // Clear existing viewer and ensure it's properly set up
                const viewerContainer = document.getElementById('pdfViewer');
                
                // Clean up any existing viewer instance
                await cleanupExistingViewer();
                
                // Wait a moment for DOM to update and ensure container is visible
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Ensure the container is visible and has dimensions
                console.log('Container dimensions:', viewerContainer.offsetWidth, 'x', viewerContainer.offsetHeight);
                console.log('Container computed style:', getComputedStyle(viewerContainer).width, 'x', getComputedStyle(viewerContainer).height);
                
                console.log('Viewer container ready, attempting to load PDF...');
                
                // Try to load PDF using Nutrient Web SDK with error handling
                try {
                    let viewer;
                    
                    // If we have an existing viewer, use the clean pattern
                    if (window.currentNutrientViewer) {
                        console.log('🔄 Using existing viewer - unloading and loading PDF...');
                        try {
                            await window.currentNutrientViewer.unload();
                            console.log('✅ Existing viewer unloaded');
                            
                            // Now load the PDF into the same viewer
                            await window.currentNutrientViewer.load({
                                document: pdfData
                            });
                            console.log('✅ PDF loaded successfully using viewer.load()!');
                            return window.currentNutrientViewer;
                            
                        } catch (viewerError) {
                            console.warn('⚠️ Viewer.load() failed, creating new viewer:', viewerError.message);
                            window.currentNutrientViewer = null;
                        }
                    }
                    
                    // If no existing viewer or viewer.load() failed, create new one
                    console.log('🔄 Creating new viewer for PDF...');
                    viewer = await NutrientViewer.load({
                        container: '#pdfViewer',
                        baseUrl: 'http://localhost:3000/assets/',
                        document: pdfData
                    });
                    
                    // Store the viewer instance for cleanup
                    window.currentNutrientViewer = viewer;
                    
                    console.log('✅ PDF loaded successfully in new viewer');
                    return viewer;
                    
                } catch (viewerError) {
                    console.error('Nutrient Viewer failed:', viewerError);
                    
                    // Fallback: show PDF as embedded object
                    console.log('Falling back to embedded PDF viewer...');
                    
                    try {
                        // Create a blob URL for the PDF data
                        const blob = new Blob([pdfData], { type: 'application/pdf' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // Store globally for cleanup
                        window.currentBlobUrl = blobUrl;
                        
                        // Create an iframe for better PDF display
                        const iframeElement = document.createElement('iframe');
                        iframeElement.src = blobUrl;
                        iframeElement.style.width = '100%';
                        iframeElement.style.height = '100%';
                        iframeElement.style.border = 'none';
                        iframeElement.style.borderRadius = '4px';
                        
                        // Clear container and add iframe
                        viewerContainer.innerHTML = '';
                        viewerContainer.appendChild(iframeElement);
                        
                        console.log('✅ Fallback PDF viewer loaded successfully');
                        return { fallback: true, blobUrl: blobUrl };
                        
                    } catch (fallbackError) {
                        console.error('Fallback viewer also failed:', fallbackError);
                        
                        // Last resort: show error message
                        viewerContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #666;">
                                <h4>PDF Conversion Successful</h4>
                                <p>Document converted to PDF (${pdfData.byteLength} bytes)</p>
                                <p>Viewer failed to load, but you can download the PDF below.</p>
                            </div>
                        `;
                        
                        return { fallback: true, error: true };
                    }
                }
                
            } catch (error) {
                console.error('Failed to display PDF:', error);
                throw new Error('Failed to display PDF: ' + error.message);
            }
        }
        

        
        // Clean up blob URLs when needed
        function cleanupBlobUrls() {
            // This function can be called to clean up any blob URLs
            // that were created for the fallback viewer or document loading
            if (window.currentBlobUrl) {
                URL.revokeObjectURL(window.currentBlobUrl);
                window.currentBlobUrl = null;
                console.log('🧹 Cleaned up blob URL');
            }
        }
        
        // Enhanced cleanup for viewer switching
        async function cleanupViewerAndBlobs() {
            try {
                if (window.currentNutrientViewer) {
                    await window.currentNutrientViewer.unload();
                    window.currentNutrientViewer = null;
                    console.log('🧹 Cleaned up viewer instance');
                }
                cleanupBlobUrls();
            } catch (error) {
                console.warn('⚠️ Error during cleanup:', error.message);
            }
        }
        

        
        // Simple fallback: get document content when all else fails
        async function getDocumentContentFallback() {
            console.log('🔄 Trying document content fallback...');
            
            try {
                const content = await getDocumentContent();
                console.log('✅ Got document content, length:', content.length, 'characters');
                
                // Create a simple document representation
                const simpleDoc = createSimpleDocumentFromContent(content);
                console.log('✅ Created simple document representation, size:', simpleDoc.byteLength, 'bytes');
                
                return simpleDoc;
            } catch (fallbackError) {
                console.error('❌ Document content fallback also failed:', fallbackError);
                throw new Error(`All approaches failed: ${fallbackError.message}`);
            }
        }
        
        // Create a simple document representation from content
        function createSimpleDocumentFromContent(content) {
            // Create a minimal document structure
            const docContent = content || 'Document content not available';
            
            // Convert to ArrayBuffer for compatibility
            const encoder = new TextEncoder();
            return encoder.encode(docContent).buffer;
        }
        
        // Helper function to encode text for PDF
        function encodeTextForPDF(text) {
            const encoder = new TextEncoder();
            return Array.from(encoder.encode(text));
        }
        

        
        // Functions moved to top of script section
    </script>
</body>
</html>
